@using System.Collections.Generic;
@page "/"


<PageTitle>Index</PageTitle>

<div class="game-top-row">
    <h1>Sandbox</h1>
    <div>
        <button class="game-button" @onclick="@StartGame" @onkeydown="@GetUserKeyInput">Start Game</button>
        <button class="game-button" @onclick="@EndGame">End Game</button>
    </div>
</div>

    <input type="text" class="game-console-input" @bind="@ConsoleInput" @bind:event="oninput"
        @onkeyup="@ProcessConsoleInput" @onkeyup:preventDefault>

<svg xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        xmlns:ev="http://www.w3.org/2001/sml-events"
        viewbox="0 0 @WIDTH @HEIGHT"
        class="arena">

@((MarkupString)SVG_Markup)

</svg>

<div class="game-console">
    @((MarkupString)ConsoleOutput)
</div>



@code {

    private static readonly int WIDTH = 900;
    private static readonly int HEIGHT = 600;
    private static readonly char[] BADCHARS = {'<', '>', '(', ')', '/', '\\', '\'', '\"', '=', ';'};

    private bool gameover = true;

    private string ConsoleInput = ">> ";
    private string ConsoleOutput = "";
    private List<string> ConsoleEntries = new List<string>();
    private int ConsoleEntriesIndex = 0;

    private static readonly string BlueColor = "#aaaacc";
    private static readonly string GreenColor = "#aaccaa";
    private static readonly string RedColor = "#ccaaaa";

    private byte pRed = 0;
    private byte pBlue = 0;
    private byte pGreen = 0;
    private string PlayerColor = "";
    private static readonly string StartColor = "#000000";



    string SVG_Markup = "<rect x=\"0\" y=\"0\" width=\"" + WIDTH + "\" height=\"" + HEIGHT
        + "\" fill=\"" + StartColor + "\"></rect>";

    private void StartGame() {
        gameover = false;
        PlayerColor = StartColor;
        SVG_Markup = Rect(0, 0, WIDTH, HEIGHT, PlayerColor);
        Console.WriteLine("Game started.");

    }

    private void PauseGame() {

        Console.WriteLine("Game paused.");
    }

    private void EndGame() {
        SVG_Markup = Rect(0, 0, WIDTH, HEIGHT, StartColor);
        gameover = true;
        Console.WriteLine("Game ended.");
    }

    private void GetUserKeyInput(KeyboardEventArgs kArgs) {

        @* Console.WriteLine("User pressed " + kArgs.Code); *@

        if (kArgs.Code.Equals("KeyR"))
            ++pRed;

        if (kArgs.Code.Equals("KeyG"))
            ++pGreen;

        if (kArgs.Code.Equals("KeyB"))
            ++pBlue;

        SVG_Markup = Rect(0, 0, WIDTH, HEIGHT, GetHexColor(pRed, pGreen, pBlue));
    }

    private void ProcessConsoleInput(KeyboardEventArgs kArgs) {

        if (kArgs.Code.Equals("ArrowUp"))
        {
            PrintToConsole("Up Arrow pressed.");
        }

        if (kArgs.Code.Equals("Enter"))
        {
            string entry = ConsoleInput;

            foreach(char c in BADCHARS)
                entry = entry.Replace(c, ' ');
            
            entry = entry.ToLower().Trim();

            while(entry.Contains("  "))
             entry = entry.Replace("  ", " ");

            if (String.IsNullOrEmpty(entry))
                return;
            
            if (entry.Equals("clear"))
            {
                ConsoleOutput = "";
            }

            else if (entry.Equals("red"))
            {
                SVG_Markup = Rect(0, 0, WIDTH, HEIGHT, RedColor);
            }

            else if (entry.Equals("green"))
            {
                SVG_Markup = Rect(0, 0, WIDTH, HEIGHT, GreenColor);
            }

            else if (entry.Equals("blue"))
            {
                SVG_Markup = Rect(0, 0, WIDTH, HEIGHT, BlueColor);
            }

            else
            {
                PrintToConsole("You entered: " + entry);
            }

            ConsoleEntries.Add(entry);
            ConsoleEntriesIndex = ConsoleEntries.Count - 1;
            ConsoleInput = ">> ";
        }

    }

    private void PrintToConsole(string str) {

        ConsoleOutput  = ("<div> - " + str + "</div>" + ConsoleOutput);
    }

    public string Rect(int x, int y, int width, int height, string color) {

        return "<rect x=\"" + x
            + "\" y=\"" + y
            + "\" width=\"" + width
            + "\" height=\"" +height
            + "\" fill=\"" + color + "\"></rect>";
    }

    public string GetHexColor(byte r, byte g, byte b) {

        return "#" + Convert.ToHexString(new byte[3] {r, g, b});
    }

}